---
title: "Binomial via counts and binary"
output: html_document
---

```{r, include=FALSE}
knitr::opts_chunk$set(comment=NA, R.options=list(width=200))
```


```{r setup}
# standard binomial regression
set.seed(1234)                                # if you want to duplicate exactly
N = 500                                       # Sample size
total = sample(10:20, N, replace=T)           # total occurrences
x = rnorm(N)                                  # covariate
eta = 0 + .3*x                                # logit; 0 is intercept, .3 is the coefficient (notice no 'error' as in standard regression)
probs = plogis(eta)                           # inverse logit to put on probability scale
y = rbinom(N, size=total, prob = probs)       # successes, generated by probability and totals
minusy = total - y                            # failures

df = data.frame(x, y, minusy, total)          # create dataframe and inspect
head(df)
```

Note the results, coefficients are about where we expect (0, .3)

```{r}
summary(glm(cbind(y, minusy) ~ x, data=df, family='binomial'))
```

Convert the data to binary.
```{r}
# as binary
ybinary = unlist(mapply(function(s, f) c(rep(1, s), rep(0, f)), df$y, df$minusy))
df2 = data.frame(x=rep(x, total), ybinary)
head(df2, 20)
```


Identical results.
```{r}
summary(glm(ybinary ~ x, data=df2, family='binomial'))
```


What if the events are rare?
```{r rare}
set.seed(1234)
totalRare = total*100
probs = plogis(-5 + .3*x)
yRare = rbinom(N, size=totalRare, prob = probs ) 

summary(cbind(yRare, totalRare, yRare/totalRare))

minusyRare = totalRare - yRare  
df3 = data.frame(x, yRare, minusyRare, totalRare)  

glmBinomRare = glm(cbind(yRare, minusyRare) ~ x, data=df3, family='binomial')
summary(glmBinomRare)
```


Compare to Poisson regression. The coefficient for x is similar. The intercept in the poisson regression is roughly the (log) count that would occur for on average across the total sizes.

```{r pois}
glmPois = glm(yRare ~ x, data=df3, family='poisson')
summary(glmPois)
c(mean(plogis(coef(glmBinomRare)[1])*totalRare), 
  exp(coef(glmPois)[1]))
```

If we actually use `totalRare` as an offset in Poisson we're dealing with the rate rather than the raw count, which would be identical to the proportion we're modeling in the binomial regression, and so the result is the same.

```{r}
glmPoisOffset = glm(yRare ~ x, offset=log(totalRare), data=df3, family='poisson')
summary(glmPoisOffset)
summary(glmBinomRare)
```

